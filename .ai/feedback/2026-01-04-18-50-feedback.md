# フィードバック

- **日時**: 2026-01-04 18:50
- **内容**: AWSのECSのヘルスチェックが失敗している。過去のfeedbackにもある127.0.0.1に変更してヘルスチェックが通っているはずだが同じ原因であるか調査
- **緊急度**: 高
- **分類**: bug
- **状態**: 調査中

## 現象

タスク定義24,25,26で新しいイメージをデプロイすると、ECSコンテナヘルスチェックが失敗する。
- タスク定義23（旧コード: 2c0b734）: 正常（ヘルスステータス「正常」）
- タスク定義24,25,26（新コード）: 異常（ヘルスステータス「異常」）

## エラーログ

```
⨯ TypeError: Cannot read properties of undefined (reading 'bind')
    at NextNodeServer.handleRequestImpl (/app/node_modules/next/dist/server/base-server.js:476:50)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
```

## 過去のフィードバック参照

### FB-2026-01-03-14-30 (対応済み)
- 内容: コンテナのヘルスチェックが不明になっている
- 対応: ECSタスク定義にヘルスチェック再設定 (`wget --quiet --tries=1 --spider http://localhost:3000/api/health`)
- **注**: 当時は `localhost:3000` を使用

### 現在のヘルスチェック設定

```json
{
  "command": ["CMD-SHELL", "/usr/bin/wget -4 -q --spider http://127.0.0.1:3000/api/health || exit 1"],
  "interval": 30,
  "timeout": 10,
  "retries": 3,
  "startPeriod": 90
}
```

## 調査状況

### 試行1: ローカルprebuiltビルド
- 結果: ローカルではヘルスチェック成功、ECSでは失敗

### 試行2: CodePipeline経由ビルド (タスク定義26)
- 結果: 同様にECSヘルスチェック失敗

### 差分分析
- タスク定義23と24-26の違いは **イメージのみ**
- 新イメージはVertex AI優先コード変更を含む
- ただしヘルスチェックエンドポイント(/api/health)は変更なし

## 考えられる原因

1. **Next.js内部エラー**: `TypeError: Cannot read properties of undefined (reading 'bind')` はNext.jsのリクエスト処理エラー
2. **node_modules依存関係問題**: ビルド時の依存関係が正しく解決されていない可能性
3. **@google/genai パッケージ**: 新しく追加したパッケージがNode.jsランタイムで問題を起こしている可能性

## 次のステップ

1. `@google/genai` パッケージのインポートを遅延読み込みに変更
2. または一時的に旧コードにロールバックして画像品質問題は別途対応

## 対応メモ

（調査中）
